<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Website Fingerprinting Lab</title>
    <style>
      * {
        margin: 0;
        padding: 0;
      }

      body {
        font-family: Arial, Helvetica, sans-serif;
        padding: 64px;
      }

      h1 {
        font-size: 32px;
        margin-bottom: 16px;
      }

      #buttons {
        margin-bottom: 16px;
      }

      button {
        background: #fff;
        border: 2px solid #3498db;
        border-radius: 4px;
        color: #3498db;
        cursor: pointer;
        display: inline-block;
        font-size: 16px;
        margin-right: 16px;
        padding: 8px 16px;
      }

      button.disabled {
        background: #ccc;
        border-color: #ccc;
        color: #666;
        cursor: default;
      }

      .trace {
        margin-bottom: 16px;
      }

      .trace-label {
        font-size: 12px;
        color: #444;
        margin-bottom: 4px;
      }

      #status {
        margin-top: 8px;
        font-size: 13px;
        color: #444;
      }

      #error {
        margin-top: 8px;
        font-size: 13px;
        color: #b00020;
        white-space: pre-wrap;
      }
    </style>
  </head>

  <body>
    <h1>Website Fingerprinting Lab</h1>

    <div id="buttons">
      <button id="collect-trace">Collect trace</button>
      <button id="download-traces">Download traces</button>
    </div>

    <div id="status"></div>
    <div id="error"></div>

    <div id="traces"></div>

    <script src="https://d3js.org/d3.v6.js"></script>
    <script type="text/javascript">
      const worker = new Worker("worker.js");

      const collectTraceButton = document.getElementById("collect-trace");
      const downloadTracesButton = document.getElementById("download-traces");
      const statusEl = document.getElementById("status");
      const errorEl = document.getElementById("error");

      window.trace_length = 5000;
      window.using_automation_script = false;

      window.recording = false;
      window.raw_traces = [];

      const WARMUP_BUCKETS_DISPLAY = 5;

      const HIGH_END_STRETCH_ALPHA = 0.35;


      let watchdog = null;

      function setStatus(msg) {
        statusEl.textContent = msg || "";
      }

      function setError(msg) {
        errorEl.textContent = msg || "";
      }

      function resetUI() {
        window.recording = false;
        collectTraceButton.innerText = "Collect trace";
        collectTraceButton.className = "";
        clearWatchdog();
      }

      function startWatchdog() {
        clearWatchdog();
        const tl =
          typeof window.trace_length === "number" && isFinite(window.trace_length)
            ? window.trace_length
            : 5000;

        const timeoutMs = tl + 15000;

        watchdog = setTimeout(() => {
          console.warn("Trace watchdog timeout hit.");
          setError(
            "Trace timed out. Most likely the worker crashed or never loaded.\n" +
              "Open DevTools Console for errors. Also ensure you're serving via http:// (not file://)."
          );
          resetUI();
        }, timeoutMs);
      }

      function clearWatchdog() {
        if (watchdog) clearTimeout(watchdog);
        watchdog = null;
      }

      function buildRankMapper(values) {
        const sorted = values.slice().sort((a, b) => a - b);
        if (sorted.length <= 1) {
          return {
            rank01: () => 0,
            sortedLen: sorted.length,
          };
        }
        return {
          rank01: (v) => {
            const idx = d3.bisectRight(sorted, v);
            return idx / (sorted.length - 1);
          },
          sortedLen: sorted.length,
        };
      }

      function highEndStretch(t, alpha) {

        return 1 - Math.pow(1 - t, alpha);
      }

      function renderAllTraces() {
        const parent = document.getElementById("traces");
        parent.innerHTML = "";

        if (window.raw_traces.length === 0) return;

        const width = parent.getBoundingClientRect().width;
        const height = 64;

        const trimmedArrays = window.raw_traces
          .map((t) => t.slice(WARMUP_BUCKETS_DISPLAY))
          .filter((t) => t.length > 0);

        if (trimmedArrays.length === 0) return;

        const flat = trimmedArrays.flat();
        if (flat.length === 0) return;

        const { rank01, sortedLen } = buildRankMapper(flat);

        let fracAbove095 = 0;
        for (let i = 0; i < flat.length; i++) {
          const r = rank01(flat[i]);
          if (r > 0.95) fracAbove095++;
        }
        fracAbove095 /= flat.length;

        function colorFor(v) {
          let t = rank01(v);

          t = highEndStretch(t, HIGH_END_STRETCH_ALPHA);

          t = Math.pow(t, FINAL_GAMMA);

          return d3.interpolatePlasma(t);
        }

        console.log({
          displayMode: "global ECDF rank + high-end stretch",
          WARMUP_BUCKETS_DISPLAY,
          HIGH_END_STRETCH_ALPHA,
          FINAL_GAMMA,
          samples: flat.length,
          sortedLen,
          fracRanksAbove0_95: fracAbove095,
          globalMin: d3.min(flat),
          globalMax: d3.max(flat),
        });

        window.raw_traces.forEach((trace, idx) => {
          const t = trace.slice(WARMUP_BUCKETS_DISPLAY);

          const row = document.createElement("div");
          row.className = "trace";
          parent.appendChild(row);

          const label = document.createElement("div");
          label.className = "trace-label";
          label.textContent = `Trace ${idx} (display trimmed: ${WARMUP_BUCKETS_DISPLAY} buckets)`;
          row.appendChild(label);

          const svg = d3
            .select(row)
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .style("shape-rendering", "crispEdges"); 

          const cellW = Math.max(1, Math.floor(width / Math.max(1, t.length)));

          svg
            .selectAll("rect")
            .data(t.map((v, i) => ({ i, v })))
            .enter()
            .append("rect")
            .attr("x", (d) => d.i * cellW)
            .attr("y", 0)
            .attr("width", cellW)
            .attr("height", height)
            .style("fill", (d) => colorFor(d.v));
        });
      }

      worker.onerror = (e) => {
        console.error("Worker error:", e);
        setError(
          "Worker error: " +
            (e.message || "unknown") +
            "\nCheck that worker.js is being served and there are no JS errors."
        );
        resetUI();
      };

      worker.onmessageerror = (e) => {
        console.error("Worker message decode error:", e);
        setError("Worker message error: could not decode message.");
        resetUI();
      };

      worker.onmessage = (e) => {
        clearWatchdog();

        window.recording = false;

        let parsed;
        try {
          parsed = JSON.parse(e.data);
        } catch (err) {
          console.error("Bad JSON from worker:", e.data);
          setError("Bad JSON from worker. Check console.");
          resetUI();
          return;
        }

        if (parsed && parsed.__error) {
          console.error("Worker reported error:", parsed);
          setError("Worker reported error:\n" + parsed.message);
          resetUI();
          return;
        }

        const trace = parsed;
        if (!Array.isArray(trace)) {
          setError("Unexpected worker output (not an array). Check console.");
          console.log("Worker output:", parsed);
          resetUI();
          return;
        }

        const mn = trace.reduce((a, b) => Math.min(a, b), Infinity);
        const mx = trace.reduce((a, b) => Math.max(a, b), -Infinity);
        console.log("trace min/max:", mn, mx);

        window.raw_traces.push(trace);

        if (!window.using_automation_script) {
          renderAllTraces();
        }

        collectTraceButton.innerText = "Collect trace";
        collectTraceButton.className = "";
        setStatus(`Collected ${window.raw_traces.length} trace(s).`);
        setError("");
      };

      function collectTrace() {
        setError("");
        setStatus("Collecting trace...");
        collectTraceButton.innerText = "Collecting trace...";
        collectTraceButton.className = "disabled";
        window.recording = true;

        startWatchdog();

        worker.postMessage({
          type: "start",
          trace_length: window.trace_length,
        });
      }

      collectTraceButton.onclick = () => {
        if (window.recording) return;

        window.recording = true;
        setError("");
        setStatus("Starting in 3...");
        collectTraceButton.innerText = "Starting in 3...";
        collectTraceButton.className = "disabled";

        setTimeout(() => {
          setStatus("Starting in 2...");
          collectTraceButton.innerText = "Starting in 2...";

          setTimeout(() => {
            setStatus("Starting in 1...");
            collectTraceButton.innerText = "Starting in 1...";
            setTimeout(collectTrace, 1000);
          }, 1000);
        }, 1000);
      };

      downloadTracesButton.onclick = () => {
        const blob = new Blob([JSON.stringify({ traces: window.raw_traces })], {
          type: "application/json",
        });

        const url = URL.createObjectURL(blob);

        const elem = document.createElement("a");
        elem.href = url;
        elem.download = "traces.json";
        document.body.appendChild(elem);

        elem.click();
        document.body.removeChild(elem);
      };

      setStatus("Ready.");
    </script>
  </body>
</html>
